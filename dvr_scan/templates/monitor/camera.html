{% extends 'base.html' %}
{% block search %}
<form class="d-flex" role="search" method="post">
    <input name="camera_id" class="form-control me-2" type="search" placeholder="Search by ID" aria-label="Search"/>
    <input class="btn btn-outline-success" type="submit" value="Search">
</form>
{% endblock %}
{% block content %}
<h1>Monitor camera</h1>
<div class="container mb-4">
    <div class="card m-1" style="width: 100%;">
        <div class="card-body">
            <h5 class="card-title">id: {{ camera.id }}</h5>
        </div>
            <!-- MJPEG Stream -->
            <img style="position: relative; display: inline-block;" id="camera-stream-{{ camera.id }}" 
                 class="img-fluid" 
                 src="{{ url_for('monitor.video_feed', camera_id=camera.id) }}">
            
            <!-- Canvas Overlay -->
            <canvas id="overlay-{{ camera.id }}" 
                    style="position: absolute; top: 0; left: 0; pointer-events: none;">
            </canvas>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cameraId = {{ camera.id }};
    const imgElement = document.getElementById(`camera-stream-${cameraId}`);
    const canvas = document.getElementById(`overlay-${cameraId}`);
    const ctx = canvas.getContext('2d');

    // Store multiple objects
    let objects = [];

    // Fetch all object centers from backend
    async function fetchCenterCoordinates() {
        try {
            const response = await fetch(`/api/center/${cameraId}`);
            if (response.ok) {
                objects = await response.json();
            }
        } catch (error) {
            console.error('Failed to fetch center coordinates:', error);
        }
    }

    // Draw all objects
    function updateOverlay() {
        canvas.width = imgElement.clientWidth;
        canvas.height = imgElement.clientHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const squareSize = Math.min(canvas.width, canvas.height) * 0.2;

        for (const obj of objects) {
            const drawCenterX = obj.centerX !== null ? obj.centerX : canvas.width / 2;
            const drawCenterY = obj.centerY !== null ? obj.centerY : canvas.height / 2;

            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 10;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(
                drawCenterX - squareSize/2, 
                drawCenterY - squareSize/2, 
                squareSize, 
                squareSize
            );

            ctx.fillStyle = '#FF0000';
            ctx.font = '16px Arial';
            ctx.fillText('Detection Zone', drawCenterX - squareSize/2, drawCenterY - squareSize/2 - 10);
        }
    }

    imgElement.onload = updateOverlay;
    window.addEventListener('resize', updateOverlay);

    setInterval(async () => {
        await fetchCenterCoordinates();
        updateOverlay();
    }, 300); // every 100ms
});
</script>
{% endblock %}
